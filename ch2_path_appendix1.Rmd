---
title: "Appendix 1 - Fitting a path model"
author: "Whalen Dillon"
date: "December 17, 2014"
output: html_document
---
----
#### This appendix details steps 1-4 of calculating the *C*-statistic for fitting a path model in a generalized multilevel context (Shipley 2009). 

I am going to start by using the path model from Fig. 7 as an example. 

**Step 1:** Express the hypothesized causal relationships between the variables in the form of a directed acyclic graph (DAG).

![Figure 7 path model](figures/ch2_path_model.png)

**Step 2:** List each of the *k* pairs of variables in the graph that do not have an arrow directly between them. The topology of the graph indicates that these variables should be independent.

Variable 1 | Variable 2
--- | ---
Elevation | Topography index
Elevation | Oak infection
Topography | Precipitation
Topography | Oak infection
Diversity | Precipitation
Diversity | Elevation

**Step 3:** For each of the *k* pairs of variables (*Xi,Xj*), list the set of other variables {*Z*} that are direct causes of either *Xi* or *Xj*. The pair of variables, (*Xi,Xj*), along with its conditioning set, {*Z*}, define an independence claim, (*Xi,Xj*) | {*Z*}, and the full set of the *k* independence claims defines the basis set, *Bu*. The basis set can be determined by using functions in the `R` package `ggm`.

First I will load the library and define the DAG using regression models and the `DAG` function. From the accompanying documentation: "The `DAG` function defines the adjacency matrix of a directed acyclic graph. An adjacency matrix is a square Boolean [e.g. 0/1] matrix that is equal to the number of nodes of the graph, with a one in a given position (i,j) if there is an arrow from i to j and zero otherwise. The row names of the adjacency matrix are the nodes of the DAG."
```{r define the DAG, eval=TRUE, echo=TRUE}
library(ggm)
fig7 <- DAG(precip ~ elev, 
    diversity ~ topo,
    temp ~ precip + elev + topo + diversity,
    oak.inf ~ leaf.ct + diversity + temp + precip,
    leaf.ct ~ diversity + temp + precip + elev + topo)
```
I can apply the `basiSet` function to this DAG to generate the full set of independence claims.
```{r get basis set, echo=TRUE, eval=TRUE}
bu_fig7 <- basiSet(fig7)
bu_fig7
```
I cleaned this list up into a table:

**The Basis Set of Independence Claims**

Independence Set | Conditioning Set
--- | ---
topo, elev | *empty*
topo, precip | elev  
topo, oak.inf | diversity, precip, temp, leaf.ct
diversity, elev | topo
diversity, precip | topo, elev
elev, oak.inf | diversity, precip, temp, leaf.ct

**Step 4:** For each element in this basis set, obtain the _**exact**_ probability, *Pk* that the pair (*Xi,Xj*) is statistically independent conditional on the variables *Z*. In other words, perform a regression model using an appropriate method. Here I am only going to formulate the models because I am still in the process of calculating variables, so I do not have values for calculating probabilities of the coefficients. The predictor variable whose independence is being checked in each model is bolded - this is the variable for which the exact probability must be recorded. I also hazard an educated guess at the distribution family of the response variable for each model.

Independence Set | Conditioning Set | Model | Distribution
--- | --- | --- | ---
topo, elev | *empty* | topo ~ **elev** | *normal*
precip, topo | elev | precip ~ elev + **topo** | *normal*
topo, oak.inf | diversity, precip, temp, leaf.ct | oak.inf ~ diversity + precip + temp + leaf.ct + **topo** | *binomial*
diversity, elev | topo | diversity ~ topo + **elev** | *normal*
diversity, precip | topo, elev | diversity ~ topo + elev + **precip** | *normal*
elev, oak.inf | diversity, precip, temp, leaf.ct | oak.inf ~ diversity + precip + temp + leaf.ct + **oak.inf** | binomial

**Step 5:** Combine the *k* probabilities into the *C*-statistic:

$$
C = -2\Sigma_{i=1}^k ln(P_i)
$$ 
Compare this *C*-statistic to a $\chi^2$ distribution with 2*k* degrees of freedom. If the model fit according to this test is sufficient (i.e. p > 0.05), then the coefficients from these models may be applied to the appropriate paths.

Noticeably, symptomatic leaf count is not part of the independence claims. If the complete model has sufficient fit then it would be modeled as either a Poisson or negative binomial distribution, and the coefficients applied to the appropriate paths.