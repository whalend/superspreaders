---
title: "Path Analysis - Chapter 2"
author: "Whalen Dillon"
date: "June 15, 2015"
output: html_document
---

#### Load data
```{r pairs helper functions, echo=FALSE}
panel.hist <- function(x, ...)
{
      usr <- par("usr"); on.exit(par(usr))
      par(usr = c(usr[1:2], 0, 1.5) )
      h <- hist(x, plot = FALSE)
      breaks <- h$breaks; nB <- length(breaks)
      y <- h$counts; y <- y/max(y)
      rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
      usr <- par("usr"); on.exit(par(usr))
      par(usr = c(0, 1, 0, 1))
      r <- abs(cor(x, y, use = "na.or.complete"))
      txt <- format(c(r, 0.123456789), digits = digits)[1]
      txt <- paste0(prefix, txt)
      if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
      text(0.5, 0.5, txt, cex = cex.cor * r)
}
```
```{r load ecological data, echo=FALSE}
# Ecological data: leaf counts, infection
load("~/GitHub/superspreaders/stems_plots.RData")
# Vegetation data
veg_us_2005 <- read.csv("analysis/data/understory_veg_2005.csv")
veg_us_2011 <- read.csv("analysis/data/understory_veg_2011.csv")
# Untagged dbh data
untagged_dbh <- read.csv("analysis/data/untagged_dbh_summary.csv")
canopy_cover <- read.csv("analysis/data/plot_canopy_cover_dens.csv")
```
```{r load physical data, echo=FALSE, message=F}
# Physical environment: topography
library(rgdal); library(plyr); library(dplyr)
plots_shp <- readOGR("analysis/data/plot_gis/", "soco_plots_metric")
plots_env <- plots_shp@data
summary(plots_env)
plots_env <- select(plots_env, -cat, -X, -Y)

# Elevation and vegetation height are in feet, slope is degrees, and canopy density is the proportion of the cell covered by canopy (0-1)
plots_topo.shp <- readOGR("analysis/data/plot_gis/", "plots202_vegtopo")
plots_vegtopo <- plots_topo.shp@data
summary(plots_vegtopo)
plots_vegtopo <- select(plots_vegtopo, -cat) %>% rename(lon_utm = X, lat_utm = Y)
```
```{r load weather data, echo=FALSE}
# Temperature: rainy season hour summaries (long format for each year)
rs_temps <- read.csv("analysis/data/rs_select_temps.csv")
summary(rs_temps)
rs_temps <- select(rs_temps, -X)

summer_temps <- read.csv("analysis/data/summer_select_temps.csv")
summary(summer_temps)
summer_temps <- select(summer_temps, -X)

# Rainfall: interpolated/estimated rainfall for each season
load("~/Documents/soco_ppt/plot_ppt_estimates.RData")
summary(ppt_days)
summary(ppt_total)
# plots_rain <- read.csv("analysis/data/plot202rain.csv")
# summary(plots_rain)
# plots_rain <- select(plots_rain, -cat)
# pairs(select(plots_rain, -PLOT_ID), 
#       lower.panel = panel.cor, 
#       diag.panel = panel.hist)
ppt_days@data <- rename(ppt_days@data, plotid = PLOT_ID)
ppt_total@data <- rename(ppt_total@data, plotid = PLOT_ID)
```

#### Join remotely sensed and derived physical data
LiDAR products, variables derived from DEMs
```{r join remotely sensed data}
plots_env <- inner_join(plots_env, plots_vegtopo, by = "PLOT_ID")
summary(plots_env)
plots_env$elev_m <- plots_env$elev15m * .3048
# plots_env <- select(plots_env, -elevation, -tmi) #remove elevation, tmi from old derivation (I think a legacy 10m USGS DEM)
plots_env$veght_m <- plots_env$veght15m * .3048
rm(plots_vegtopo)
```

#### Convert rain data from wide to long
```{r rain wide to long}
library(tidyr)
rain2d_total <- ppt_total@data %>% select(plotid, ends_with("2d"))
names(rain2d_total) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain2d_total <- rain2d_total %>% gather(year, rain_tot_2d, -plotid)

rain3d_total <- ppt_total@data %>% select(plotid, ends_with("3d"))
names(rain3d_total) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain3d_total <- rain3d_total %>% gather(year, rain_tot_3d, -plotid)

rain_v_total <- ppt_total@data %>% select(plotid, ends_with("v"))
names(rain_v_total) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain_v_total <- rain_v_total %>% gather(year, rain_tot_v, -plotid)

rain_r_total <- ppt_total@data %>% select(plotid, ends_with("r"))
names(rain_r_total) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain_r_total <- rain_r_total %>% gather(year, rain_tot_r, -plotid)

rain_psm_total <- ppt_total@data %>% select(plotid, contains("sum"))
names(rain_psm_total) <- c("plotid", paste(c(2004:2010), sep = ","))
rain_psm_total <- rain_psm_total %>% gather(year, rain_tot_psm, -plotid)


rain2d_days <- ppt_days@data %>% select(plotid, ends_with("2d"))
names(rain2d_days) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain2d_days <- rain2d_days %>% gather(year, rain_days_2d, -plotid)

rain3d_days <- ppt_days@data %>% select(plotid, ends_with("3d"))
names(rain3d_days) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain3d_days <- rain3d_days %>% gather(year, rain_days_3d, -plotid)

rain_v_days <- ppt_days@data %>% select(plotid, ends_with("v"))
names(rain_v_days) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain_v_days <- rain_v_days %>% gather(year, rain_days_v, -plotid)

rain_r_days <- ppt_days@data %>% select(plotid, ends_with("r"))
names(rain_r_days) <- c("plotid",paste(c(2004:2012,2014), sep = ","))
rain_r_days <- rain_r_days %>% gather(year, rain_days_r, -plotid)


rain_total <- left_join(rain2d_total, 
                        left_join(rain3d_total, rain_v_total, 
                                  by = c("plotid","year")),
                        by = c("plotid","year"))
rain_total <- left_join(rain_total, rain_r_total, by = c("plotid", "year"))
rain_total <- left_join(rain_total, rain_psm_total, by = c("plotid", "year"))

rain_days <- left_join(rain2d_days,
                       left_join(rain3d_days, rain_v_days, 
                                 by = c("plotid", "year")),
                       by = c("plotid", "year"))
rain_days <- left_join(rain_days, rain_r_days, by = c("plotid", "year"))


rm(list = ls(pattern = "^rain_v"))
rm(list = ls(pattern = "^rain2d"))
rm(list = ls(pattern = "^rain3d"))
rm(list = ls(pattern = "^rain_r"))
rm(rain_psm_total)

write.csv(rain_total, "analysis/data/rain_total_long.csv", row.names = F)
write.csv(rain_days, "analysis/data/rain_days_long.csv", row.names = F)
```

#### Explore data for completeness and matching
```{r explore plot_env data, message=FALSE}
summary(plots_env)
str(plots_env)
plots_env <- plots_env %>% rename(plotid = PLOT_ID)

write.csv(plots_env, "analysis/data/env_gis_variables.csv", row.names = F)
plots_env <- read.csv("analysis/data/env_gis_variables.csv")
```

Examine temperature data, which is in long format and covers sample years 2004 through 2014. This means that I will need to exclude disease-related sampling from 2003.
```{r examine temperature & rain data}
summary(plots_temps)
summary(rain_days)
summary(rain_total)
unique(plots_temps$plotid)# 201 levels
unique(rain_days$plotid)# 202 levels
unique(rain_total$plotid)# 202 levels
tempsid <- as.character(unique(plots_temps$plotid))
rainid <- as.character(unique(rain_days$plotid))
rainid %in% tempsid
rainid[62]# BUSH01 still in the rain data
rain_days <- filter(rain_days, plotid != "BUSH01")
rain_total <- filter(rain_total, plotid != "BUSH01")
# Temperature and rainfall data now have same number of observations
rm(tempsid); rm(rainid)
```

#### Investigating `NAs` in the `plots_temps` data set
A number of observations for above 25 threshold have NAs. I believe that these are in fact truly zero observations. NAs occurred for the 2010, 2011, and 2014 seasons, and the only NAs in the data set are associated with the above 25 threshold. I do believe that it is possible that the temperature was never above 25 C during the wet season November - May in some years.
```{r investigate NAs, eval=FALSE, echo=FALSE}
# summary(plots_env)
# filter(plots_env, plotid == "BUSH01")

# BUSH01 plot included. I think we have limited ecological data for this plot, and no microclimate data. So, I am going to exclude it from all the data sets
# plots_env <- filter(plots_env, plotid != "BUSH01")
stems <- rename(stems, plotid = plot) %>% filter(plotid != "BUSH01")

plots_temps %>% filter(is.na(hrs_abv25))
# I am replacing the NAs with `0`, assuming true observations.
plots_temps[is.na(plots_temps)] <- 0
```

#### Save data with BUSH01 excluded
```{r save data}
write.csv(plots_env, "analysis/data/env_gis_variables.csv", row.names = F)
write.csv(rain_data, "analysis/data/rain_data_long.csv", row.names = F)
write.csv(plots_temps, "analysis/data/temp_data_long.csv", row.names = F)
write.csv(stems, "analysis/data/stems_noBUSH01.csv", row.names = F)
rm(plots_temps); rm(plots_rain)
```

#### Reload data that has BUSH01 excluded
```{r reload data}
plots_env <- read.csv("analysis/data/env_gis_variables.csv")
rain_data <- read.csv("analysis/data/rain_data_long.csv")
temps_data <- read.csv("analysis/data/temp_data_long.csv")
stems <- read.csv("analysis/data/stems_noBUSH01.csv")
```

#### Plot contributing area vs. slope
This is a suggestion from Ryan to plot the contributing area vs. the slope for each of the plots in order to tease out how either influences infection and hosts. Decomposing TWI to determine which factor has a greater influence on disease dynamics. 
```{r decomposing TWI influence}
library(ggplot2)
# summary(plots_vegtopo)
# par(mfrow = c(3,1))
qplot(slope15m, flowacc15m, data = plots_env) +
      geom_text(aes(label = plotid))
qplot(slope15m, flowacc15m, data = filter(plots_env, flowacc15m < 20), 
      main = "Flow Accumulation < 20") +
      geom_text(aes(label = plotid))
qplot(slope15m, flowacc15m, data = filter(plots_env, flowacc15m > 20 & flowacc15m < 1000), main = "Flow Accumulation 20 - 1000") +
      geom_text(aes(label = plotid))
qplot(slope15m, flowacc15m, data = filter(plots_env, flowacc15m > 1000), 
      main = "Flow Accumulation > 1000") +
      geom_text(aes(label = plotid))

qplot(slope15m, facc_ws15m, data = plots_env)
qplot(slope15m, facc_ws15m, data = filter(plots_env, facc_ws15m < 15), 
      main = "facc < 15") +
      geom_text(aes(label = plotid))
qplot(slope15m, facc_ws15m, data = filter(plots_env, facc_ws15m > 15 & facc_ws15m < 50), 
      main = "facc 15 - 50") +
      geom_text(aes(label = plotid))
qplot(slope15m, facc_ws15m, data = filter(plots_env, facc_ws15m > 50 & facc_ws15m < 200), 
      main = "facc 50 - 200") +
      geom_text(aes(label = plotid))
qplot(slope15m, facc_ws15m, data = filter(plots_env, facc_ws15m > 200 & facc_ws15m < 1000), 
      main = "facc 200 - 1000") +
      geom_text(aes(label = plotid))
qplot(slope15m, facc_ws15m, data = filter(plots_env, facc_ws15m > 1000), 
      main = "facc >1000") +
      geom_text(aes(label = plotid))

# pairs(select(plots_env, -plotid, -starts_with("rain")), 
#       lower.panel = panel.cor, diag.panel = panel.hist)
# pairs(select(plots_env, -plotid, -starts_with("rain")) %>% 
#             filter(flowacc15m < 5), 
#       lower.panel = panel.cor, diag.panel = panel.hist,
#       main = "Flow accumualtion < 5")
# pairs(select(plots_env, -plotid, -starts_with("rain")) %>% 
#             filter(flowacc15m > 100 & flowacc15m < 1000), 
#       lower.panel = panel.cor, diag.panel = panel.hist,
#       main = "Flow accumulation 100-1000")
# pairs(select(plots_env, -plotid, -starts_with("rain")) %>% 
#             filter(flowacc15m > 1000), 
#       lower.panel = panel.cor, diag.panel = panel.hist,
#       main = "Flow accumulation > 1000")

plot(flowacc15m ~ slope15m, data = filter(plots_env, flowacc15m < 30))
pairs(select(plots_env, -plotid) %>% filter(flowacc15m < 30), 
      lower.panel = panel.cor, diag.panel = panel.hist)

library(manipulate)
manipulate(
      qplot(slope15m, flowacc15m, data = plots_env,
           axes = axes,
           cex = cex,
           pch = if(pch) 19 else 1
           ),
      axes = checkbox(TRUE, "Show axes"),
      cex = slider(0, 5, initial = 1, step = 0.1, label = "Point size"),
      pch = button("Fill points")
)

dataplot <- function(dat){
      name <- sys.call()[[2]]
      vars <- as.list(names(dat))
      e <- new.env()
      e$data <- name
      manipulate(
            {
                  form = as.formula(paste(y,x, sep = "~"))
                  plot(form, data = dat, main = as.character(name), las = 1)
                  e$form <- form
            },
            x = do.call(picker, c(vars, initial = vars[1])),
            y = do.call(picker, c(vars, initial = vars[2]))
      )
      invisible(e)
}
f <- dataplot(plots_env)
```

#### Examine the bay laurel data at individual and plot levels
```{r examine umca data}
summary(plots_umca)
# This only has number of infected, uninfected, and total, which must apply to living stems only. I want to analyze leaf counts.
unique(plots_umca$plot)
umca_plots <- filter(plots_umca, plot != "BUSH01")
rm(plots_umca)
summary(bay_laurel) # This has stem-level data on bay laurel.
unique(bay_laurel$plot)
bay_laurel <- filter(bay_laurel, plot != "BUSH01")
```

I can use this to calculate plot level leaf count variables (sum, average) for each plot and year
```{r calculate plot level leaf counts}
umca_plots <- left_join(umca_plots, bay_laurel %>% filter(status == "Alive") %>% group_by(plot, year) %>%  summarise(
            avg_lfct = mean(slc, na.rm = T),
            tot_lfct = sum(slc, na.rm = T)),
      by = c("plot", "year"))
summary(umca_plots)
```

```{r examine lfct NAs}
filter(umca_plots, is.na(avg_lfct))
# I'm not sure why this wasn't excluded from the calculations with the na.rm = T option
filter(bay_laurel, plot == "YAHNG02", status == "Alive")
# I'm removing it manually from the `plots_umca` data frame
umca_plots <- umca_plots %>% filter(avg_lfct != "NaN")
summary(umca_plots)
```


So now I have a plot-level of UMCA infection levels for each year. I want to join this with some of the environmental data.
```{r join env and umca data}
summary(plots_env)
plots_env$avg_psi <- rowMeans(cbind(plots_env$psiSpr, plots_env$psiSum, plots_env$psiWin))
summary(plots_umca)
# plot == plotid, year == sample_year
plots_umca <- left_join(select(plots_umca, -species), plots_env, by = c("plot" = "plotid"))
summary(plots_umca)
filter(plots_umca, is.na(easting))
# NAs due to no topo data for abandoned SUGAR02
plots_umca <- na.omit(plots_umca)

plots_temps <- as.tbl(plots_temps)
plots_temps <- plots_temps %>% rename(year = sample_year)
plots_temps$plotid <- tolower(plots_temps$plotid)

plots_umca <- left_join(plots_umca, plots_temps, by = c("plotid", "year"))
```


#### Community vegetation data and variables
Now I also want to calculate some plot-level community variables from the vegetation data. First, understory richness from the vegetation transects.

```{r calculate understory richness}
summary(veg_us_2005)
veg_us_2005 <- as.tbl(select(veg_us_2005, -X))
summary(veg_us_2011)
veg_us_2011 <- as.tbl(select(veg_us_2011, -X))
veg_us_2011
veg_us_2005

veg <- rbind(veg_us_2005, veg_us_2011)
unique(veg$year)
veg$year[veg$year < 2011] <- 2005 # Creates the two most complete veg sampling
veg <- veg %>% rename(us_species = UnderstorySp, plotid = PlotID)
unique(veg$us_species)

# I want to match the species to those used by Sarah in her second chapter
local_woody <- read.csv("analysis/data/presence_local_woody_n197.csv")
summary(local_woody)
unique(local_woody$spp.local)
woody_spp <- as.character(local_woody$spp.local)
woody_spp[woody_spp == "prunus"] <- "prunus sp."
sort(woody_spp) # only 29 species
sort(unique(veg$us_species))
# It looks like I will want to add a few more to her list

filter(veg, us_species == "ribes sp.")
filter(veg, us_species == "ribes")
veg$us_species[veg$us_species == "ribes"] <- "ribes sp."

woody_spp <- c(woody_spp, "ceanothus sp.", "cebe", "cecu", "frla", "garrya sp.", "gemo", "juca", "mafu", "mane", "mimulus sp", "pisa", "quag x quke", "qube", "quercus sp.", "quwi", "rhamnus sp.", "rhcr", "ribes sp.", "rica", "risa", "roca", "rosa sp.", "rubus sp.", "rudi", "salix sp.", "syal", "vaccinium sp.")
veg_sub <- filter(veg, veg$us_species %in% woody_spp)
veg_sub <- droplevels(veg_sub)

richness <- veg_sub %>%
      group_by(plotid, year) %>% 
      summarise(us_rich = length(unique(us_species)))
richness
```


Next, overstory richness from the DBH data for tagged & untagged stems.

```{r calculate overstory richness}
summary(untagged_dbh)
untagged_dbh <- as.tbl(untagged_dbh %>% select(-X) %>% rename(plotid = PlotID, species = Species))
untagged_dbh
unique(untagged_dbh$year)
untagged_dbh$year[untagged_dbh$year < 2014] <- 2005 # Create two most complete groups
untagged_dbh$plotid <- tolower(untagged_dbh$plotid)
unique(untagged_dbh$plotid)
untagged_dbh <- filter(untagged_dbh, plotid != "bush01")
untagged_dbh %>% group_by(plotid, year) %>% summarise(untagged_rich = length(unique(species)))

stems <- as.tbl(stems)
summary(stems)
unique(stems$status)
stems <- stems %>% select(-X) %>% filter(status == "Alive" | status == "Dead")
unique(stems$species)
unique(stems$plotid)
stems$species <- tolower(stems$species)
stems$species[stems$species == "quke x quag"] <- "quag x quke"
stems$plotid <- tolower(stems$plotid)
stems <- droplevels(stems)


live_tagged <- stems %>% filter(status == "Alive") %>% group_by(plotid, year, species) %>% summarise(live_count = length(species))
unique(live_tagged$species)
os_richness <- rbind(live_tagged, select(untagged_dbh, plotid, species, year, live_count))

os_richness <- left_join(
      stems %>% filter(year == 2005 | year == 2014) %>% 
            group_by(plotid, year) %>% 
            summarise(tagged_rich = length(unique(species))),
      untagged_dbh %>% 
            group_by(plotid, year) %>% 
            summarise(untagged_rich = length(unique(species))), by = c("plotid", "year")) %>% 
      mutate(os_rich = rowSums(cbind(tagged_rich,untagged_rich), na.rm = T))
os_richness

richness <- left_join(os_richness, richness, by = c("plotid","year"))
richness
summary(richness)
```


Now I want to join the richness data set and the canopy cover estimates to the `umca_plots` data frame that currently has the environmental and leaf count/infection variables. 

```{r join richness and umca data}
umca_plots
richness
umca_plots <- rename(umca_plots, plotid = plot)
umca_plots$plotid <- tolower(umca_plots$plotid)

umca_plots <- left_join(umca_plots, richness, by = c("plotid", "year"))
head(canopy_cover)
canopy_cover <- select(canopy_cover, -X)
umca_plots <- left_join(umca_plots, canopy_cover, by = c("plotid", "year"))
```

Make a pairs plot of the continuous variables for UMCA plots.
```{r umca sod pairs plot}
# Helper functions for `pairs`
panel.hist <- function(x, ...)
{
      usr <- par("usr"); on.exit(par(usr))
      par(usr = c(usr[1:2], 0, 1.5) )
      h <- hist(x, plot = FALSE)
      breaks <- h$breaks; nB <- length(breaks)
      y <- h$counts; y <- y/max(y)
      rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
      usr <- par("usr"); on.exit(par(usr))
      par(usr = c(0, 1, 0, 1))
      r <- abs(cor(x, y, use = "na.or.complete"))
      txt <- format(c(r, 0.123456789), digits = digits)[1]
      txt <- paste0(prefix, txt)
      if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
      text(0.5, 0.5, txt, cex = cex.cor * r)
}

umca_plots <- ungroup(umca_plots)

# pairs(select(plots_umca, -plotid, -year, -starts_with("psi"), -tagged_rich, -untagged_rich), lower.panel = panel.cor, diag.panel = panel.hist, main = "UMCA SOD Data")
```

Now that I have summarized some vegetation (not species specific), environmental, and bay laurel disease data to the plot-level I want to join this and the canopy cover data to the plot-level oak infection data.

```{r join umca and qusp data}
umca_plots
plot_qusp # right now this is broken down by oak species
qusp_plots <- plot_qusp
rm(plot_qusp)
summary(qusp_plots)
qusp_plots
oak_sod <- qusp_plots %>% group_by(plot, year) %>%
      summarise(uninf_oak_ct = sum(uninfected_oak_ct), 
                inf_oak_ct = sum(infected_oak_ct), 
                tot_oak_ct = sum(c(uninfected_oak_ct, infected_oak_ct)))
oak_sod
oak_sod <- rename(oak_sod, plotid = plot)
oak_sod$plotid <- tolower(oak_sod$plotid)


oak_sod <- left_join(oak_sod, select(umca_plots, plotid, year, uninfected_bay_ct, infected_bay_ct, tot_bay, avg_lfct, tot_lfct), 
                     by = c("plotid", "year"))
summary(oak_sod) # the NA's for the bay laurel variables are legitimately zeroes b/c there are no bay in some of these plots
filter(oak_sod, is.na(tot_bay))
oak_sod$uninfected_bay_ct[is.na(oak_sod$uninfected_bay_ct)] <- 0
oak_sod$infected_bay_ct[is.na(oak_sod$infected_bay_ct)] <- 0
oak_sod$tot_bay[is.na(oak_sod$tot_bay)] <- 0

plots_env
plots_env$plotid <- tolower(plots_env$plotid)
oak_sod <- left_join(oak_sod, plots_env, by = "plotid")
head(temps_data, 15)
temps_data$plotid <- tolower(temps_data$plotid)
temps_data <- rename(temps_data, year = sample_year)
oak_sod <- left_join(oak_sod, temps_data, by = c("plotid", "year"))
oak_sod
names(oak_sod)

richness
oak_sod <- left_join(oak_sod, richness, by = c("plotid", "year"))
summary(oak_sod)
filter(oak_sod, is.na(elev15m))
oak_sod <- filter(oak_sod, plotid != "duer01", plotid != "ponti01", plotid != "sweet01")

summary(filter(oak_sod, is.na(avg_tmax)))
filter(oak_sod, is.na(avg_tmax), year == 2005) # BUSH01 plot; I'm dropping that from the data set
oak_sod <- filter(oak_sod, plotid != "bush01")
filter(oak_sod, is.na(avg_tmax), year == 2004) # PONTI01 and SWEET01 were other early abandoned plots
oak_sod <- filter(oak_sod, plotid != "ponti01", plotid != "sweet01")
summary(filter(oak_sod, is.na(avg_tmax))) # Now the NAs in the temperature variables are just for year 2003 when we had severely incomplete temperature data
summary(oak_sod)
filter(oak_sod, is.na(easting))
oak_sod <- filter(oak_sod, plotid != "duer01")

filter(oak_sod, plotid == "ann05") # There is no 2007 record for ann05 in the UMCA form, but there is a plot visit. I will need to come back and investigate this further for correcting the database.
oak_sod$infected_bay_ct[oak_sod$plotid == "ann05" & oak_sod$year == 2007] <- 15
oak_sod$tot_bay[oak_sod$plotid == "ann05" & oak_sod$year == 2007] <- 15
# I filled in the counts based on the values in the immediately preceding and following years, which I think is pretty solid reasoning. However, there is nothing I can do about the leaf counts.
summary(oak_sod)

oak_sod <- left_join(oak_sod, canopy_cover, by = c("plotid", "year"))
summary(rain_data)
rain_data$plotid <- tolower(rain_data$plotid)
oak_sod <- left_join(oak_sod, rain_data, by = c("plotid", "year"))
summary(filter(oak_sod, is.na(avg_tmax))) # all obs from 2003

filter(oak_sod, year == 2003) # 85 records
filter(oak_sod, year == 2004) # 88 records
# 2005 appears to be the first full year of observing all the plots
filter(oak_sod, year == 2005) # 170 records
filter(oak_sod, year == 2006) # 172 records
filter(oak_sod, year == 2007) # 171 records
filter(oak_sod, year == 2008) # 171 records
filter(oak_sod, year == 2009) # 170 records
filter(oak_sod, year == 2010) # 170 records
filter(oak_sod, year == 2011) # 170 records; final year for Sarah's 2nd chapter
filter(oak_sod, year == 2012) # 169 records
filter(oak_sod, year == 2014) # 168 records
# In Sarah's analysis we end up using only 163 plots
```


Now to do a pairs plot of the `oak_sod` data frame

```{r oak_sod pairs plot}
class(oak_sod)
oak_sod <- ungroup(oak_sod)
pairs(select(oak_sod, -plotid, -year, -starts_with("psi"), -tagged_rich, -untagged_rich), lower.panel = panel.cor, diag.panel = panel.hist, main = "Oak_SOD Data")
```

# Path Analysis Presented at 2015 IALE World Congress 

#### Path Analysis Plot-Level Oak Infection 2005
Here I am using the `oak_sod` data set which will be the oak infection (binomial) as the terminal response variable.

```{r oak_sod path model 2005}
library(ggm)
names(oak_sod)
oak_path1 <- DAG(
      twi15m ~ elev15m,
      os_rich ~ twi15m,
      hrs_14_20 ~ elev15m + d2c + avg_psi + twi15m,
      tot_lfct ~ hrs_14_20 + os_rich + d2c,
      inf_oak_ct ~ tot_lfct + os_rich + hrs_14_20 + d2c
      )
isAcyclic(oak_path1)
bu_oak_path1 <- basiSet(oak_path1)
bu_oak_path1

oak_path2 <- DAG(
      twi15m ~ elev15m,
      os_rich ~ twi15m,
      hrs_blw10 ~ elev15m + d2c + avg_psi + twi15m,
      tot_lfct ~ hrs_blw10 + os_rich + d2c,
      inf_oak_ct ~ tot_lfct + os_rich + hrs_blw10 + d2c
      )
isAcyclic(oak_path2)

oak_2005 <- filter(oak_sod, year == 2005)
summary(oak_2005)
oak_2005 <- select(oak_2005, plotid, uninf_oak_ct, inf_oak_ct, tot_lfct, hrs_14_20, hrs_blw10, hrs_abv25, avg_tmax, avg_tmin, rain05_2d, rain05_v, elev15m, twi15m, avg_psi, os_rich, d2c)
oak_2005$tot_lfct[is.na(oak_2005$tot_lfct)] <- 0
filter(oak_2005, is.na(os_rich))
# oak_2005 <- na.omit(oak_2005)
oak_2005$plotid <- as.factor(oak_2005$plotid)

# This model makes Gaussian assumptions, which should be incorrect for these data
shipley.test(oak_path1, cov(select(oak_2005, elev15m, twi15m, os_rich, hrs_14_20, d2c, avg_psi, tot_lfct, inf_oak_ct)), n = 170)
# The p-value of 0.08 indicates that there is not a severe violation of the conditional independence assumptions with the application of a Gaussian model

shipley.test(oak_path2, cov(select(oak_2005, elev15m, twi15m, os_rich, hrs_blw10, d2c, avg_psi, tot_lfct, inf_oak_ct)), n = 170)
# The p-value of .04 indicates that the conditional independence assumptions under the application of a Gaussian model are questionable.
```


Violation or questioning of conditional independence supports addressing the complexity of the data using different model distributions to deal with the data.

```{r assess conditional independence claims 2005}
bu_oak_path1 # 15 independence claims means 15 models
library(nlme); library(lme4); library(MuMIn)

f1 <- lme(avg_psi ~ d2c, data = oak_2005, random = ~1|plotid)
summary(f1) # p = 0.5091
f2 <- lme(avg_psi ~ elev15m, data = oak_2005, random = ~1|plotid)
summary(f2) # p = 0.2013
f3 <- lme(avg_psi ~ twi15m + elev15m, data = oak_2005, random = ~1|plotid)
summary(f3) # twi15m; p = 0.0959
f4 <- lme(os_rich ~ avg_psi + twi15m, data = oak_2005, random = ~1|plotid)
summary(f4) # avg_psi; p = 0.1712
f5 <- lm(log1p(tot_lfct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2005)
# f5 <- lme(log1p(tot_lfct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2005, random = ~1|plotid)
# f5 <- glmer(tot_lfct ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + (1|plotid), data = oak_2005, family = "poisson")
summary(f5) # avg_psi; p = 0.5993
# f6 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2005, family = "binomial")
# f6 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2005, family = "quasibinomial")
f6 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct) + (1|plotid), data = oak_2005, family = "binomial")
summary(f6) # avg_psi; p = 0.08970
f7 <- lm(elev15m ~ d2c, data = oak_2005)
# f7 <- lme(elev15m ~ d2c, data = oak_2005, random = ~1|plotid)
summary(f7) # p = 0.03184
f8 <- lm(log(twi15m) ~ d2c + elev15m, data = oak_2005)
# f8 <- lme(log(twi15m) ~ d2c + elev15m, data = oak_2005, random = ~1|plotid)
summary(f8) # d2c; p = 0.3693
f9 <- lm(os_rich ~ d2c + twi15m, data = oak_2005)
# f9 <- lme(os_rich ~ d2c + twi15m, data = oak_2005, random = ~1|plotid)
summary(f9) # d2c; p = 0.9370
f10 <- lm(os_rich ~ elev15m + twi15m, data = oak_2005)
# f10 <- lme(os_rich ~ elev15m + twi15m, data = oak_2005, random = ~1|plotid)
summary(f10) # elev15m; p = 0.19174

# f11 <- lm(tot_lfct ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2005)
# f11 <- lm(log1p(tot_lfct) ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2005)
f11 <- glm(tot_lfct ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2005, family = "poisson")
chat <- deviance(f11)/df.residual(f11)
library(MuMIn)
x.quasipoisson<-function(...){
  res<-quasipoisson(...)
  res$aic<-poisson(...)$aic
  res
}
QAIC(update(f11, family = x.quasipoisson), chat = chat)
f11 <- glm(tot_lfct ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2005, family = "quasipoisson")
# f11 <- lme(log1p(tot_lfct) ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), random = ~1|plotid, data = oak_2005)
# f11 <- glmer(tot_lfct ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + (1|plotid), data = oak_2005, family = "poisson")
summary(f11) # elev15m; p = 0.360630

# f12 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2005, family = "binomial")
# chat <- deviance(f12)/df.residual(f12)
# QAIC(update(f12, family = x.quasibinomial), chat = chat)
# f12 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2005, family = "quasibinomial")
f12 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(elev15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct) + (1|plotid), data = oak_2005, family = "binomial")
summary(f12) # elevation; p = 0.44861

f13 <- lm(log1p(tot_lfct) ~ scale(twi15m) + scale(d2c) + scale(elev15m) + scale(hrs_14_20) + scale(os_rich), data = oak_2005)
# f13 <- lme(log1p(tot_lfct) ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich), data = oak_2005, random = ~1|plotid)
# f13 <- glmer(tot_lfct ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich) + (1|plotid), data = oak_2005, family = "poisson")
summary(f13) # twi15m; p = 0.801

# f14 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tmi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2005, family = "binomial")
# chat <- deviance(f14)/df.residual(f14)
# QAIC(update(f14, family = x.quasibinomial), chat = chat)
# f14 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tmi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2005, family = "quasibinomial")

f14 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(twi15m) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct) + (1|plotid), data = oak_2005, family = "binomial")
summary(f14) # twi15m; p = 0.61177

f15 <- lm(os_rich ~ hrs_14_20 + avg_psi + d2c + elev15m + twi15m, data = oak_2005)
# f15 <- lme(os_rich ~ hrs_14_20 + avg_psi + d2c + elevation + tmi, data = oak_2005, random = ~1|plotid)
summary(f15) # hrs_14_20; p = 0.08468

# Calculate C-statistic
pvalues <- c(summary(f1)$tTable[2,5], summary(f2)$tTable[2,5], summary(f3)$tTable[2,5], summary(f4)$tTable[2,5], summary(f5)$coefficients[2,4], summary(f6)$coefficients[2,4], summary(f7)$tTable[2,5], summary(f8)$tTable[2,5], summary(f9)$tTable[2,5], summary(f10)$tTable[2,5], summary(f11)$coefficients[2,4], summary(f12)$coefficients[2,4], summary(f13)$coefficients[2,4], summary(f14)$coefficients[2,4], summary(f15)$tTable[2,5])

cstat <- -2 * sum(log(pvalues))
cstat
```

Given the C-statistic of 26.9 and that 2k degrees of freedom would be 30 I think that this meets the criteria for supporting the conditional independence claims. So, this supports my path model, now I need to run the models to produce estimates for the path coefficients. This is the model set that I need to get the estimated path coefficients:

      1. os_rich ~ twi15m,
      2. hrs_14_20 ~ elev15m + d2c + avg_psi + twi15m,
      3. tot_lfct ~ hrs_14_20 + os_rich + d2c,
      4. infected oak ~ tot_lfct + os_rich + hrs_14_20 + d2c

```{r estimate path coefficients 2005}
# f0 <- fitted(mlme1, level = 0)# Values from population model
# f1 <- fitted(mlme1, level = 1)# Within beach fitted values

# fit1 <- lm(tmi ~ scale(elevation), data = oak_2005)
fit1 <- lm(log(tmi) ~ scale(elevation), data = oak_2005) # best model
# fit1 <- lme(log(tmi) ~ scale(elevation), data = oak_2005, random = ~1|plotid, method = "ML")
summary(fit1)
par(mfrow = c(2,2))
plot(fit1)

# fit2 <- lm(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi), data = oak_2005)
# fit2 <- lme(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi), data = oak_2005, random = ~1|plotid) # best model
fit2 <- glmer(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi) + (1|plotid), data = oak_2005, family = "poisson")
# fit2 <- glmer.nb(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi) + (1|plotid), data = oak_2005)
summary(fit2)
plot(fit2)

# fit3 <- lm(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c), data = oak_2005)
fit3 <- lm(log1p(tot_lfct) ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c), data = oak_2005)
fit3 <- glm(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c), data = oak_2005, family = "poisson")
(chat <- deviance(fit3) / df.residual(fit3))
x.quasipoisson<-function(...){
  res<-quasipoisson(...)
  res$aic<-poisson(...)$aic
  res
}
library(MuMIn)
QAIC(update(fit3, family = x.quasipoisson), chat = chat) # 178.3
fit3 <- glm(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c), data = oak_2005, family = "quasipoisson") # best model
# fit3 <- glmer(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c) + (1|plotid), data = oak_2005, family = "poisson")
summary(fit3)

# fit4 <- lm((inf_oak_ct/(inf_oak_ct+uninf_oak_ct)) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c), data = oak_2005)
# par(mfrow = c(2,2))
# plot(fit4)

# fit4 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c), data = oak_2005, family = "binomial")
# (chat <- deviance(fit4) / df.residual(fit4))
# x.quasibinomial<-function(...){
#   res<-quasibinomial(...)
#   res$aic<-binomial(...)$aic
#   res
# }
# library(MuMIn)
# QAIC(update(fit4, family = x.quasibinomial), chat = chat)
# fit4 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c), data = oak_2005, family = "quasibinomial")
# summary(fit4)

fit4 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tot_lfct) + scale(os_rich) + scale(d2c) + (1|plotid), data = oak_2005, family = "binomial") # best model
summary(fit4)

fit5 <- lm(os_rich ~ tmi, data = oak_2005); AIC(fit5)
# fit5 <- lme(os_rich ~ tmi, data = oak_2005, random = ~1|plotid)
summary(fit5)

# Trying to plot the fitted model by each group...
# f0 <- fitted(fit4, level = 0)
# f1 <- fitted(fit4, level = 1)
# 
# f0[I]
# 
# I <- order(oak_2005$tot_lfct) ; lfct <- sort(oak_2005$tot_lfct)
# plot(lfct, f0[I], lwd = 4, type = "l",
#      ylab = "oak infection", xlab = "total leaf count")
# for(i in 1:length(f1)){
#       x1 <- oak_2005$hrs_14_20[oak_2005$plotid == i]
#       y1 <- f1[oak_2005$hrs_14_20 == i]
#       K <- order(x1)
#       lines(sort(x1), y1[K], col = "red")
# }
# text(oak_2005$hrs_14_20, oak_2005$tot_lfct, oak_2005$plotid, cex = 0.9)
```


#### Path Analysis Oak Infection - 2014
Now I am going to fit the same path model to data from 2011.

```{r oak_sod path model 2014}
oak_path1 <- DAG(
      tmi ~ elevation,
      os_rich ~ tmi,
      hrs_14_20 ~ elevation + d2c + avg_psi + tmi,
      tot_lfct ~ hrs_14_20 + os_rich + d2c,
      inf_oak_ct ~ tot_lfct + os_rich + hrs_14_20 + d2c
      )

oak_2014 <- filter(oak_sod, year == 2014)
oak_2014 %>% select(plotid, tagged_rich, untagged_rich, os_rich) %>%
      filter(is.na(os_rich))
summary(oak_2014)
oak_2014 <- select(oak_2014, plotid, uninf_oak_ct, inf_oak_ct, tot_lfct, hrs_14_20, hrs_blw10, hrs_abv25, elevation, tmi, avg_psi, os_rich, d2c)
oak_2014$tot_lfct[is.na(oak_2014$tot_lfct)] <- 0
oak_2014 <- na.omit(oak_2014)
oak_2014$plotid <- as.factor(oak_2014$plotid)

shipley.test(oak_path1, cov(select(oak_2014, elevation, tmi, os_rich, hrs_14_20, d2c, avg_psi, tot_lfct, inf_oak_ct)), n = 168)
# Strongly significant p-value

# shipley.test(DAG(
#       tmi ~ elevation,
#       os_rich ~ tmi,
#       hrs_blw10 ~ elevation + d2c + avg_psi + tmi,
#       tot_lfct ~ hrs_blw10 + os_rich + d2c,
#       inf_oak_ct ~ tot_lfct + os_rich + hrs_blw10 + d2c), 
#       cov(select(oak_2014, elevation, tmi, os_rich, hrs_blw10, d2c, avg_psi, tot_lfct, inf_oak_ct)), 
#       n = 168)
```

```{r assess conditional independence 2014}
f1 <- lme(avg_psi ~ d2c, data = oak_2014, random = ~1|plotid)
summary(f1) # p = 0.591
f2 <- lme(avg_psi ~ elevation, data = oak_2014, random = ~1|plotid)
summary(f2) # p = 0.2171
f3 <- lme(avg_psi ~ tmi + elevation, data = oak_2014, random = ~1|plotid)
summary(f3) # tmi; p = 0.1889
f4 <- lm(os_rich ~ avg_psi + tmi, data = oak_2014)
# f4 <- lme(os_rich ~ avg_psi + tmi, data = oak_2014, random = ~1|plotid)
summary(f4) # avg_psi; p = 0.156
f5 <- lm(log1p(tot_lfct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2014)
# f5 <- lme(log1p(tot_lfct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2014, random = ~1|plotid)
# f5 <- glmer(tot_lfct ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + (1|plotid), data = oak_2014, family = "poisson")
summary(f5) # avg_psi; p = 0.265

f6 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2014, family = "binomial")
chat <- deviance(f6)/df.residual(f6)
QAIC(update(f6, family = x.quasibinomial), chat = chat)
f6 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2014, family = "quasibinomial")
# f6 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(avg_psi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct) + (1|plotid), data = oak_2014, family = "binomial")
summary(f6) # avg_psi; p = 0.000722

f7 <- lm(log(elevation) ~ d2c, data = oak_2014)
# f7 <- lme(log(elevation) ~ d2c, data = oak_2014, random = ~1|plotid)
summary(f7) # p = 0.0101

f8 <- lm(log(tmi) ~ d2c + elevation, data = oak_2014)
# f8 <- lme(log(tmi) ~ d2c + elevation, data = oak_2014, random = ~1|plotid)
summary(f8) # d2c; p = 0.65795

f9 <- lm(log1p(os_rich) ~ d2c + tmi, data = oak_2014)
# f9 <- lme(log1p(os_rich) ~ d2c + tmi, data = oak_2014, random = ~1|plotid)
summary(f9) # d2c; p = 0.73

f10 <- lm(log1p(os_rich) ~ elevation + tmi, data = oak_2014)
# f10 <- lme(log1p(os_rich) ~ elevation + tmi, data = oak_2014, random = ~1|plotid)
summary(f10) # elevation; p = 0.126

# f11 <- lm(tot_lfct ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2014)
f11 <- lm(log1p(tot_lfct) ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2014)
f11 <- glm(tot_lfct ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2014, family = "poisson")
chat <- deviance(f11)/df.residual(f11)
QAIC(update(f11, family = x.quasipoisson), chat = chat)
f11 <- glm((tot_lfct) ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), data = oak_2014, family = "quasipoisson")
# f11 <- lme(log1p(tot_lfct) ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich), random = ~1|plotid, data = oak_2014)
# f11 <- glmer(tot_lfct ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + (1|plotid), data = oak_2014, family = "poisson")
summary(f11) # elevation; p = 0.0170

f12 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2014, family = "binomial")
chat <- deviance(f12)/df.residual(f12)
QAIC(update(f12, family = x.quasibinomial), chat = chat)
f12 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2014, family = "quasibinomial")
# f12 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(elevation) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct) + (1|plotid), data = oak_2014, family = "binomial")
summary(f12) # elevation; p = 0.00627

f13 <- lm(log1p(tot_lfct) ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich), data = oak_2014)
f13 <- glm(tot_lfct ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich), data = oak_2014, family = "poisson")
chat <- deviance(f13)/df.residual(f13)
QAIC(update(f13, family = x.quasipoisson), chat = chat)
f13 <- glm(tot_lfct ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich), data = oak_2014, family = "quasipoisson")

# f13 <- lme(log1p(tot_lfct) ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich), data = oak_2014, random = ~1|plotid)
# f13 <- glmer(tot_lfct ~ scale(tmi) + scale(d2c) + scale(elevation) + scale(hrs_14_20) + scale(os_rich) + (1|plotid), data = oak_2014, family = "poisson")
summary(f13) # tmi; p = 0.2562

f14 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tmi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2014, family = "binomial")
chat <- deviance(f14)/df.residual(f14)
QAIC(update(f14, family = x.quasibinomial), chat = chat)
f14 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tmi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct), data = oak_2014, family = "quasibinomial")
# f14 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tmi) + scale(d2c) + scale(hrs_14_20) + scale(os_rich) + scale(tot_lfct) + (1|plotid), data = oak_2014, family = "binomial")
summary(f14) # tmi; p = 0.7633

f15 <- lm(log1p(os_rich) ~ hrs_14_20 + avg_psi + d2c + elevation + tmi, data = oak_2014)
# f15 <- lme(log1p(os_rich) ~ hrs_14_20 + avg_psi + d2c + elevation + tmi, data = oak_2014, random = ~1|plotid)
summary(f15) # hrs_14_20; p = 0.1039

# Calculate C-statistic
pvalues <- c(summary(f1)$tTable[2,5], summary(f2)$tTable[2,5], summary(f3)$tTable[2,5], summary(f4)$coefficients[2,4], summary(f5)$coefficients[2,4], summary(f6)$coefficients[2,4], summary(f7)$coefficients[2,4], summary(f8)$coefficients[2,4], summary(f9)$coefficients[2,4], summary(f10)$coefficients[2,4], summary(f11)$coefficients[2,4], summary(f12)$coefficients[2,4], summary(f13)$coefficients[2,4], summary(f14)$coefficients[2,4], summary(f15)$coefficients[2,4])

cstat <- -2 * sum(log(pvalues))
cstat # 69.18
chisq.test(c(cstat,30))
qchisq(pvalues, df = 30)
chisq.test(cbind(pvalues, qchisq(pvalues, df = 30)))
```

This C-statistic is much larger than the degrees of freedom, so I'm not confident in the conditional independencies of the structural model being met for the 2014 data. In fact, based on the C-test value from the earlier call to `shipleys.test` on these data this value is significantly different.

The models testing for conditional independence indicate direct effects of PSI and elevation on oak infection, as well as a direct effect of elevation on symptomatic leaf count. This is indicated by the p-values showing strong statistical significance in the relationship between these variables. Below I have generated a new path model that accounts for the unassumed direct effects, which means they become assumed direct effects.

```{r oak path 2014 v2}
oak_path2 <- DAG(
      tmi ~ elevation,
      os_rich ~ tmi,
      hrs_14_20 ~ elevation + d2c + avg_psi + tmi,
      tot_lfct ~ hrs_14_20 + os_rich + d2c + elevation,
      inf_oak_ct ~ tot_lfct + avg_psi + os_rich + hrs_14_20 + d2c + elevation
      )
isAcyclic(oak_path2)
bu_oak_path2 <- basiSet(oak_path2)
bu_oak_path2

shipley.test(oak_path2, cov(select(oak_2014, elevation, tmi, os_rich, hrs_14_20, d2c, avg_psi, tot_lfct, inf_oak_ct)), n = 168)

plotGraph(oak_path2)
```

This means commenting out models `f6` (oak ~ PSI), `f12` (oak ~ elevation), and `f11` (leaf count ~ elevation) in the `pvalues` summary.

```{r recalculate c-statistic}
pvalues <- c(
      summary(f1)$tTable[2,5], summary(f2)$tTable[2,5], summary(f3)$tTable[2,5],
      summary(f4)$coefficients[2,4], summary(f5)$coefficients[2,4], 
             # summary(f6)$coefficients[2,4], 
      summary(f7)$coefficients[2,4], summary(f8)$coefficients[2,4],
      summary(f9)$coefficients[2,4], summary(f10)$coefficients[2,4],
      # summary(f11)$coefficients[2,4], 
      # summary(f12)$coefficients[2,4], 
      summary(f13)$coefficients[2,4], summary(f14)$coefficients[2,4], summary(f15)$coefficients[2,4])

cstat <- -2 * sum(log(pvalues))
cstat # 36.56767
chisq.test(c(cstat,30))
```
I think this would be evidence for wanting/needing to use the repeated measures approach across all the data to capture interannual variation in the relationships.

I am continuing with fitting the models to estimate the path coefficients for 2014 data based on this redrawn path model.

```{r estimate path coefficients 2014}
# f0 <- fitted(mlme1, level = 0)# Values from population model
# f1 <- fitted(mlme1, level = 1)# Within beach fitted values

# fit1_2014 <- lm(tmi ~ scale(elevation), data = oak_2014)
fit1_2014 <- lm(log(tmi) ~ scale(elevation), data = oak_2014) # best model
# fit1_2014 <- lme(log(tmi) ~ scale(elevation), data = oak_2014, random = ~1|plotid)
summary(fit1_2014)
par(mfrow = c(2,2))
plot(fit1_2014)

# fit2_2014 <- lm(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi), data = oak_2014)
# fit2_2014 <- lme(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi), data = oak_2014, random = ~1|plotid) # best model
fit2_2014 <- glm(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi), data = oak_2014, family = "poisson")
chat <- deviance(fit2_2014)/df.residual(fit2_2014)
QAIC(update(fit2_2014, family = x.quasipoisson), chat = chat)
fit2_2014 <- glm(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi), data = oak_2014, family = "quasipoisson")
# fit2_2014 <- glmer(hrs_14_20 ~ scale(elevation) + scale(d2c) + scale(avg_psi) + scale(tmi) + (1|plotid), data = oak_2014, family = "poisson")
summary(fit2_2014)
plot(fit2_2014)

# fit3_2014 <- lm(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c) + scale(elevation), data = oak_2014)
# fit3_2014 <- lm(log1p(tot_lfct) ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c) + scale(elevation), data = oak_2014)
fit3_2014 <- glm(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c) + scale(elevation), data = oak_2014, family = "poisson")
(chat <- deviance(fit3_2014) / df.residual(fit3_2014))
x.quasipoisson<-function(...){
  res<-quasipoisson(...)
  res$aic<-poisson(...)$aic
  res
}
library(MuMIn)
QAIC(update(fit3_2014, family = x.quasipoisson), chat = chat) # 178.3
fit3_2014 <- glm(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c) + scale(elevation), data = oak_2014, family = "quasipoisson") # best model
# fit3_2014 <- glmer(tot_lfct ~ scale(hrs_14_20) + scale(os_rich) + scale(d2c) + scale(elevation) + (1|plotid), data = oak_2014, family = "poisson")
summary(fit3_2014)

# fit4_2014 <- lm((inf_oak_ct/(inf_oak_ct+uninf_oak_ct)) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c) + scale(elevation) + scale(avg_psi), data = oak_2014)
par(mfrow = c(2,2))
plot(fit4_2014)

fit4_2014 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c) + scale(elevation) + scale(avg_psi), data = oak_2014, family = "binomial")
(chat <- deviance(fit4_2014) / df.residual(fit4_2014))
x.quasibinomial<-function(...){
  res<-quasibinomial(...)
  res$aic<-binomial(...)$aic
  res
}
library(MuMIn)
QAIC(update(fit4_2014, family = x.quasibinomial), chat = chat)
fit4_2014 <- glm(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c) + scale(elevation) + scale(avg_psi), data = oak_2014, family = "quasibinomial")

# fit4_2014 <- glmer(cbind(inf_oak_ct, uninf_oak_ct) ~ scale(tot_lfct) + scale(os_rich) + scale(hrs_14_20) + scale(d2c) + (1|plotid), data = oak_2014, family = "binomial") # best model
summary(fit4_2014)

# fit5_2014 <- lm(os_rich ~ tmi, data = oak_2014); AIC(fit5_2014)
fit5_2014 <- lm(log(os_rich) ~ tmi, data = oak_2014); AIC(fit5_2014)
# fit5_2014 <- lme(os_rich ~ tmi, data = oak_2014, random = ~1|plotid)
# fit5_2014 <- lme(log(os_rich) ~ tmi, data = oak_2014, random = ~1|plotid)
summary(fit5_2014)
```


#### Importance Value
I also want to calculate some variables related to DBH, and in particular the "importance value" for each species. Importance value is calculated in the literature as:

`IV = 0.5 * (relative density / relative dominance)` where 
 - `Relative Density = # stems of species / total # of stems` and
 - `Relative Dominance = basal area of species / total basal area`

```{r calculate importance value}
unique(untagged_dbh$species)
untagged_dbh
unique(stems$species)

tagged_dbh <- left_join(stems %>% 
      filter(status == "Alive", location == "In") %>%
      select(plotid, year, species, dbh) %>% 
      group_by(plotid, species, year) %>% 
      summarise(live_count = length(species), live_avg_dbh = mean(dbh), live_tot_dbh = sum(dbh)),
      stems %>% 
      filter(status == "Dead", location == "In") %>%
      select(plotid, year, species, dbh) %>% 
      group_by(plotid, species, year) %>% 
      summarise(dead_count = length(species), dead_avg_dbh = mean(dbh), dead_tot_dbh = sum(dbh)),
      by = c("plotid", "species", "year")
)
tagged_dbh <- as.tbl(tagged_dbh)
summary(tagged_dbh)

tagged_dbh
untagged_dbh

species_dbh <- rbind(tagged_dbh, untagged_dbh)
species_dbh
unique(species_dbh$species)
species_dbh %>% group_by(plotid, species, year)

stems_dbh <- species_dbh %>% group_by(plotid, year) %>% mutate(all_live_count = sum(live_count), all_live_dbh = sum(live_tot_dbh, na.rm = T), all_dead_count =  sum(dead_count, na.rm = T), all_dead_dbh = sum(dead_tot_dbh, na.rm = T))
stems_dbh
summary(stems_dbh)
filter(stems_dbh, all_live_dbh > 800)

stems_dbh <- stems_dbh %>% mutate(rel_dens = live_count / all_live_count, rel_dom = live_tot_dbh / all_live_dbh, imp_value = 0.5*(rel_dens + rel_dom))
summary(stems_dbh)
write.csv(stems_dbh, "analysis/data/species_dbh_impval_plot.csv")
```

```{r pare down stems dataframe}
stems %>% select(year, tag, species, status, notes) %>% filter(species == "umca") 
summary(stems) # Limited to "Alive/Dead"" status, "Missing" statuses excluded
unique(stems$species)
unique(stems$plotid)
summary(bay_laurel) # Still includes stems with "Missing" status
unique(bay_laurel$plot)

names(stems)
stemssub <- select(stems, plotid, year, cluster, tag, species, status, slc, canker, dbh, lide_lf_symp, sod_dead, location, dbh1, dbh2, delta_dbh, dbh2_1_ratio, inst_grwth_rate, doy, date)
summary(stemssub)
str(stemssub)

summary(oak_sod) # plots with oak stems
summary(umca_plots) # plots with bay laurel stems
summary(rain_data)
summary(temps_data)
summary(plots_env)
summary(veg_sub)
summary(richness)
summary(stems_dbh)

save.image("~/GitHub/superspreaders/data_201508.RData")
```

```{r}
load("~/GitHub/superspreaders/data_201508.RData")
stemssub$cluster <- as.factor(stemssub$cluster)
stemssub$tag <- as.factor(stemssub$tag)
stemssub$canker <- as.factor(stemssub$canker)
stemssub$sod_dead <- as.factor(stemssub$sod_dead)
stemssub$date <- as.Date(stemssub$date)
str(stemssub)
```

